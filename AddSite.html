<html>
<head>
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="Stylesheet" type="text/css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
<link rel="stylesheet" href="http://hydvspsdev04/sites/DMS/Style%20Library/assets/css/sweetalert.css"  type="text/css">

</head>
<body>

<script src="/sites/DMS/Style Library/assets/js/libs/jquery/jquery-1.11.2.min.js"></script>
<script type="text/javascript" src="_layouts/15/sp.runtime.js"></script>
<script type="text/javascript" src="_layouts/15/sp.js"></script>

<script src="/sites/DMS/Style Library/assets/js/libs/jquery/jquery-migrate-1.2.1.min.js"></script>
<script src="/sites/DMS/Style Library/assets/js/libs/bootstrap/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>

<script src="/sites/DMS/Style Library/assets/js/libs/spin.js/spin.min.js"></script>
<script src="/sites/DMS/Style Library/assets/js/libs/autosize/jquery.autosize.min.js"></script>
<script src="/sites/DMS/Style Library/assets/js/libs/multi-select/jquery.multi-select.js"></script>

<script src="/sites/DMS/Style Library/assets/js/libs/nanoscroller/jquery.nanoscroller.min.js"></script>
<script src="/sites/DMS/Style Library/assets/js/libs/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="/sites/DMS/Style Library/assets/js/libs/jquery-validation/dist/additional-methods.min.js"></script>
<script src="/sites/DMS/Style Library/assets/js/core/source/App.js"></script>
<script src="/sites/DMS/Style Library/assets/js/core/source/AppNavigation.js"></script>
<script src="/sites/DMS/Style Library/assets/js/core/source/AppForm.js"></script>
<script src="/sites/DMS/Style Library/assets/js/libs/sweetalert/sweetalert2.min.js"></script>

<script src='/sites/DMS/Style Library/assets/js/libs/DataTables/jquery.dataTables.min.1.10.12.js'></script>
<script src='/sites/DMS/Style Library/assets/js/libs/DataTables/dataTables.bootstrap.min.js'></script>
<script src='/sites/DMS/Style Library/assets/js/libs/DataTables/dataTables.buttons.min.js'></script>
<script src='/sites/DMS/Style Library/assets/js/libs/DataTables/jszip.min.js'></script>
<script src='/sites/DMS/Style Library/assets/js/libs/DataTables/buttons.html5.min.js'></script>
<script src='/sites/DMS/Style Library/assets/js/libs/DataTables/buttons.print.min.js'></script>

<script type="text/javascript" src="/_layouts/15/clientpeoplepicker.js?rev=kOIhJa70anmQclPB3z5S4Q%3D%3DTAG0"></script>
<script type="text/javascript" src="/sites/DMS/style%20library/assets/pnp/fetch.min.js"></script>
<script type="text/javascript" src="/sites/DMS/style%20library/assets/pnp/es6-promise.min.js"></script>
<script type="text/javascript" src="/sites/DMS/style%20library/assets/pnp/pnp.min.js"></script>
<script type="text/javascript" src="/sites/DMS/style%20library/assets/angular/angular.min.js"></script>
<script>
    //Init Promise
    ES6Promise.polyfill();

    //Setup PNP header
    $pnp.setup({
        headers: {
            "Accept": "application/json; odata=verbose"
                //,"X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                //"content-type": "application/json;odata=verbose",
                //"If-Match": "*"
        }
    });
</script>

<style>
.dt-buttons {
        display: block;
        
    }
    
    .ApprovalHistoryTable_wrapper {
        margin-left: 100px;
    }
    
    th {
        background-color: steelblue;
        color: white;
        text-align: center;
    }
    
    tr {
        text-align: center;
    }
    
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }
}

#loading {
   width: 100%;
   height: 100%;
   top: 0;
   left: 0;
   position: fixed;
   display: block;
   opacity: 0.7;
   background-color: #fff;
   z-index: 99;
   text-align: center;
}

#loading-image {
  position: absolute;
 <!-- top: 100px;-->
  left: 240px;
  z-index: 100;
  margin-left:30%;
}
</style>
<div id="loading">
  <img id="loading-image" src="/sites/DMS/PublishingImages/LoadingScreen.gif" style="display:block"alt="Loading..." />
</div>
<div id="SiteCreatinInfo" style=" margin-left: 30%; display:none" > Please wai while your site is being Created..... </div>

<div id="TestLoading" style="padding-left:23%">
<div class="row">
<div class="col-lg-6">
    <div class="col-lg-12 form-group">
        <h5><b>Site Name </b></h5>
	    <input name="SiteName" id="SiteName" placeholder="Site Name" class="form-control" type="text" >
    </div>
    <div class="col-lg-12 form-group">
        <h5><b>Site Description</b></h5>
        <textarea  id="SiteDescription " placeholder="Site Description" class="form-control" rows="10"  style="resize: none"></textarea >
    </div>

    <div class="col-lg-12">
        <button id="CreateSite" class="btn btn-success pull-right" type="button" onclick="CreateNewSite()"> Create Site</button>
    </div>

</div>

</div>
</div>

<script type="text/javascript">
	var SiteName = "";
var SiteUrl = "";
var CONST_PROJECT_TEMPLATE = "";
var RootSIteOwnerGroup = "DMS Owners";
var HomePage = _spPageContextInfo.siteAbsoluteUrl;
var MemberGroup = "";
var OwnerGroup = "";
var VisitorGroup = "";
var RootSiteOwnerGroup = "DMS Owners";


//var ServiceUrl="";
//ShowLoadingScreen();
$(document).ready(function () {

HideLoadingScreen();

});


function CreateNewSite() {

	debugger
	if (ValidateSpecialCharacterAndBlank() == "IsBlank")
	{
		alert("Site Name can't be empty");
		return false;
	}
	
	else if(ValidateSpecialCharacterAndBlank() == "HasSpecialCharacters")
	{
		alert("Any Special Character is not allowed in Site Name");
		return false;

	}
	else
	{
		ShowLoadingScreen();
		SiteName = $("#SiteName").val();
		SiteUrl = SiteName.replace(/ /g, '');
		console.log(SiteName);
		console.log(SiteUrl);
		CONST_PROJECT_TEMPLATE = "TestTemplate";
		CheckIfSiteExists();
		/*ShowLoadingScreen();
		$("#SiteCreatinInfo").show()
		ExecuteOrDelayUntilScriptLoaded(GetTemplate(), "sp.js");*/
	
	}

}

function GetTemplate() {
	
	var ctx = new SP.ClientContext.get_current(); //lientContext.get_current();
	this.webTemplates = ctx.get_web().getAvailableWebTemplates(1033, false);
	ctx.load(webTemplates);
	ctx.executeQueryAsync(onGetTemplateQuerySucceeded, onGetTemplateQueryFailed);

}

function onGetTemplateQuerySucceeded(sender, args) {
	var tmpls = webTemplates.getEnumerator();
	while (tmpls.moveNext()) {
		var tmpl = tmpls.get_current();
		if (tmpl.get_title() == CONST_PROJECT_TEMPLATE) {
			siteTemplate = tmpl.get_name();
		}
	}


	//Create SPWeb
	var ctx2 = new SP.ClientContext.get_current();
	var webCreationInformation = new SP.WebCreationInformation();
	webCreationInformation.set_title(SiteName);
	webCreationInformation.set_description(SiteName);
	webCreationInformation.set_language(1033);
	webCreationInformation.set_url(SiteUrl);
	//Set false, if Unique Permissions are required
	webCreationInformation.set_useSamePermissionsAsParentSite(false);
	webCreationInformation.set_webTemplate(siteTemplate);
	var newSiteObj = ctx2.get_web().get_webs().add(webCreationInformation);
	ctx2.executeQueryAsync(
		function () {
			console.log("Site Created");
			createSPGroups(SiteName);
		},
		function (sender, args) {
			console.error(args.get_message());
		}
	);

}

function onGetTemplateQueryFailed() {
	console.log("Error in getting Template");
	alert("Something went Wrong!! \nFailed while getting Template\n Please contact Sharepoint Team");
	
}

function createSPGroups(SiteName) {
	//Load new Site
	var currentCTX = new SP.ClientContext.get_current();
	var currentWEB = currentCTX.get_web();

	//Get all groups in site
	var groupCollection = currentWEB.get_siteGroups();

	// Create Group information for a Group
	var membersGRP = new SP.GroupCreationInformation();
	membersGRP.set_description('Use this group to grant people contribute permissions to the SharePoint site: ');

	var ownerGRP = new SP.GroupCreationInformation();
	ownerGRP.set_description('Use this group to grant people Owner permissions to the SharePoint site: ');

	var visitorGRP = new SP.GroupCreationInformation();
	visitorGRP.set_description('Use this group to grant people Reader permissions to the SharePoint site: ');

	MemberGroup = SiteName + " Member";
	//OwnerGroup = SiteName + " Owner";
	VisitorGroup = SiteName + " Visitors";
	membersGRP.set_title(MemberGroup);
	//ownerGRP.set_title(OwnerGroup);
	visitorGRP.set_title(VisitorGroup);


	//add  group
	currentWEB.get_siteGroups().add(membersGRP);
	//currentWEB.get_siteGroups().add(ownerGRP);
	currentWEB.get_siteGroups().add(visitorGRP);
	currentCTX.executeQueryAsync(Function.createDelegate(this, AddGroupToSite), Function.createDelegate(this, this.onQueryFailed));
}

function AddGroupToSite()

{

	console.log("Group Created.Adding Groups to Newly Created SIte");
	//Load new Site
	var NewsubsiteUrl = _spPageContextInfo.webAbsoluteUrl + "/" + SiteUrl;
	var currentCTX = new SP.ClientContext(NewsubsiteUrl); //.get_current();

	var currentWEB = currentCTX.get_web(NewsubsiteUrl);
	// var SubWeb=currentCTX.get_web(NewsubsiteUrl);

	//Get all groups in site
	var groupCollection = currentWEB.get_siteGroups();

	// my group
	//var SubsiteOwnerGroup = currentWEB.get_siteGroups().getByName(OwnerGroup);

	//var SubsiteFullPermissions = currentWEB.get_roleDefinitions().getByName('Full Control');

	var SiteOwnerGroup = currentWEB.get_siteGroups().getByName(RootSiteOwnerGroup);

	var SiteFullPermissions = currentWEB.get_roleDefinitions().getByName('Full Control');


	var SubsiteMemberGroup = currentWEB.get_siteGroups().getByName(MemberGroup);

	var SubsiteContibutePermissions = currentWEB.get_roleDefinitions().getByName('Contribute');

	var SubsiteVisitorGroup = currentWEB.get_siteGroups().getByName(VisitorGroup);

	var SubsiteReadPermissions = currentWEB.get_roleDefinitions().getByName('Read');


	// Create a new RoleDefinitionBindingCollection.
	//var collFullControl = SP.RoleDefinitionBindingCollection.newObject(currentCTX);
	var collRootSIteFullControl = SP.RoleDefinitionBindingCollection.newObject(currentCTX);
	var collEditControl = SP.RoleDefinitionBindingCollection.newObject(currentCTX);
	var collReadControl = SP.RoleDefinitionBindingCollection.newObject(currentCTX);

	// Add the role to the collection.
	//collFullControl.add(SubsiteFullPermissions);
	collRootSIteFullControl.add(SiteFullPermissions);
	collEditControl.add(SubsiteContibutePermissions);
	collReadControl.add(SubsiteReadPermissions);


	// Get the RoleAssignmentCollection for the target web.

	var assignments = currentWEB.get_roleAssignments();

	// assign the group to the new RoleDefinitionBindingCollection.

	//assignments.add(SubsiteOwnerGroup, collFullControl);
	assignments.add(SiteOwnerGroup, collRootSIteFullControl);
	assignments.add(SubsiteMemberGroup, collEditControl);
	assignments.add(SubsiteVisitorGroup, collReadControl);


	currentWEB.update();

	currentCTX.executeQueryAsync(Function.createDelegate(this, success), Function.createDelegate(this, this.failed));

}


function onQueryFailed(sender, args) {
	console.log("Site Created. Failed while creating Sharepoint Groups");
	alert("Something went Wrong!! \nFailed while Creating Groups\n Please contact Sharepoint Team");
}

function success() {
	HideLoadingScreen();
	$("#SiteCreatinInfo").hide();
	//alert("Site Created Successfully");
	if (confirm("Site Created Successfully.\nPress 'OK' to go to new Site \n Else Press 'Cancel' ")) {
     window.location.replace(_spPageContextInfo.webAbsoluteUrl+"/"+SiteUrl);
  } else {
    location.reload();
  }

	console.log("Permission Assigned");
}

function failed(sender, args) {
	
	console.log("Site Created. Sharepoint Groups Created. Permission Assignment Failed");
	alert("Something went Wrong!! \nFailed while adding Permission to SIte\n Please contact Sharepoint Team");


}

function ShowLoadingScreen() {
    $("#TestLoading").hide();
    $("#loading").show();
}

function HideLoadingScreen() {
    $("#loading").hide();
    $("#TestLoading").show();
}

function ValidateSpecialCharacterAndBlank()
{
	var SpecialCharacterSet= /[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi;
	var CheckForBlank = /^\s*$/;
	debugger;
	if(CheckForBlank.test($("#SiteName").val()))
	{
		return "IsBlank";
	}
	else if(SpecialCharacterSet.test($("#SiteName").val()))
	{
		return "HasSpecialCharacters";
	}
	else
	{
		return "ValidationPass";
	}
	
}

function CheckIfSiteExists()
{

	var NewsubsiteUrl = _spPageContextInfo.webAbsoluteUrl + "/" + SiteUrl;
	var currentCTX = new SP.ClientContext(NewsubsiteUrl); //.get_current();

	this.currentWEB = currentCTX.get_web(NewsubsiteUrl);
	debugger;
	currentCTX.load(currentWEB);
	currentCTX.executeQueryAsync(Function.createDelegate(this, CheckIfSiteExistsSuccess), Function.createDelegate(this, CheckIfSiteExistsFail));


	
}

function CheckIfSiteExistsSuccess(sender, args)
{
	
	console.log("Site Exists");
	alert("Site with same name already Exists.Please use a Different name");
	HideLoadingScreen();
}

function CheckIfSiteExistsFail(sender, args)
{
	console.log("SIte Doesn't exists. Ok to Proceed");
	$("#SiteCreatinInfo").show();
	ExecuteOrDelayUntilScriptLoaded(GetTemplate(), "sp.js");
	//HideLoadingScreen();
}

</script>

</body>
</html>

